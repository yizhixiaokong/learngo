# wire

wire是一个代码生成工具，它可以帮助我们生成依赖注入代码。

[wire](https://github.com/google/wire)

## 安装

```shell
go install github.com/google/wire/cmd/wire@latest
```

## 使用

确保你的`$GOPATH/bin`在你的`$PATH`中

创建一个go项目

```shell
go mod init wire-demo
```

创建 greeter.go 文件

```go
package main

import "fmt"

type Message string

type Greeter struct {
    Message Message
}
type Event struct {
    Greeter Greeter
}

func NewMessage(msg string) Message {
    return Message(msg)
}

func NewGreeter(m Message) Greeter {
    return Greeter{Message: m}
}

func NewEvent(g Greeter) Event {
    return Event{Greeter: g}
}

func (g Greeter) Greet() Message {
    return g.Message
}
func (e Event) Start() {
    msg := e.Greeter.Greet()
    fmt.Println(msg)
}
```

创建 wire.go 文件

```go
//go:build wireinject
// +build wireinject

package main

import "github.com/google/wire"

func InitializeEvent(msg string) Event {
    panic(wire.Build(NewEvent, NewGreeter, NewMessage)) // 补充说明3
    // wire.Build(NewEvent, NewGreeter, NewMessage)
    // return Event{}
}
```

生成

```shell
wire
```

会在目录下生成 wire_gen.go 文件

```go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package main

// Injectors from wire.go:

func InitializeEvent(msg string) Event {
    message := NewMessage(msg)
    greeter := NewGreeter(message)
    event := NewEvent(greeter)
    return event
}
```

创建 main.go 文件

```go
package main

func main() {
    e := InitializeEvent("hello world!!!")
    e.Start()
}
```

运行

```shell
go run .
# hello world!!!
```

补充说明：

- `//go:build xxx` 是golang的构建约束语法，用于指定编译条件，在go1.17之前，这个语法是`// +build xxx`，gofmt会在遇到旧语法时自动添加上等效的新语法。
- `//go:build wireinject` , wire工具会根据这个条件来判断是否需要生成代码。
- 步骤`创建 wire.go 文件`的补充说明3处，由于此处代码是用于生成代码的，所以不会实际运行，使用`panic`可以简化写法。不使用`panic`的话，需要像注释中的代码一样，返回值符合函数签名。